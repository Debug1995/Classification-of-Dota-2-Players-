<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>DOTA TAG</title>

    <!-- Bootstrap core CSS -->
    <link href="static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="static/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="static/vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- Custom styles for this template -->
    <link href="static/css/landing-page.min.css" rel="stylesheet">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.0/jquery.min.js"></script>
    <script type="text/javascript">

      // init
      $(document).ready(function() {
        $.ajaxSetup({ cache: false });
      });


      $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
      $(function() {
        $('#valid').hide();
        $('#invalid').hide();
      });

      function update_profile(data) {
        if (data.result = "OK") {
          $('#tags').empty();
          for (i = 0; i < data.result.length; i++) {
            $("#tags").append("<button type=\"button\" class=\"btn btn-primary\">" + data.tags[i] + "</button>");
          }
          $("#name").text(data.name)
          $("#personaname").text(data.personaname)
          $("#avatar").attr("src",data.img_url);
          $('#valid').show();
          $('#vis').empty();
          draw_graph();     

        }
      }

      $(document).ready(function() {
        $('#search_btn').on("click", function(e) {
          /* Act on the event */
          var steamid;
          steamid = $('#steamid').val();
          console.log(steamid);

          $.getJSON($SCRIPT_ROOT + '/query', {
            x: $('#steamid').val()
          }, function(data) {
            console.log(data);
            update_profile(data);
          });

          e.preventDefault(); 
          return false
        });
      });


      // post steamid
      //var xmlhttp;
      //xmlhttp=new XMLHttpRequest();
    </script>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <style>
      @import url(http://fonts.googleapis.com/css?family=Source+Code+Pro:400,600);

      path.link {
        fill: none;
        stroke-width: 2px;
      }
      .node:not(:hover) .nodetext {
        display: none;
      }
      a:link { color: #EE3124; text-decoration: none;}
      a:visited { color: #EE3124; }
      a:hover { color: #A4CD39; text-decoration: underline;}
      a:active { color: #EE3124; }
    </style>

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-light bg-light static-top">
      <div class="container">
          <h4>DOTA TAG</h4>
      </div>
    </nav>

    <!-- Masthead -->
    <header class="masthead text-white text-center">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-md-10 col-lg-8 col-xl-7 mx-auto">
            <form role="form">
              <div class="form-row">
                <div class="col-12 col-md-9 mb-2 mb-md-0">
                  <input id="steamid" name="steamid" type="steamid" class="form-control form-control-lg" value="{{request.form.steamid}}" placeholder="Enter your Dota2 ID...">
                </div>
                <div class="col-12 col-md-3">
                  <button id="search_btn" type="submit" class="btn btn-block btn-lg btn-primary">Search</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </header>

    <!-- Testimonials -->
    <section class="testimonials text-center bg-light">
      <div class="container" id="valid">
        <h2 class="mb-5">Profile</h2>
        <div class="row">
          <div class="col-md-4">
            <div class="testimonial-item mx-auto mb-5 mb-lg-0">
              <img id="avatar" class="img-fluid rounded-circle mb-3" src="static/img/testimonials-3.jpg" alt="">
              <h5 id="name"></h5>
              <p id="personaname" class="font-weight-light mb-0"></p>
            </div>
          </div>
          <div class="col-md-8"  id="tags">
          </div>
        </div>
        <p><hr/></p>
        <h3> TAG MAP </h3>
        <div class="row" id="graph_frame">
          <div class="col-md-12" id="vis">
              <script>
              // some colour variables
              var tcBlack = "#130C0E";

              // rest of vars
              var w = 960,
                  h = 800,
                  maxNodeSize = 50,
                  x_browser = 20,
                  y_browser = 25,
                  root;
                 
              var vis;
              var force = d3.layout.force();

              function draw_graph() {

                vis = d3.select("#vis").append("svg").attr("width", w).attr("height", h);
                 
                d3.json("/json", function(json) {
                  console.log(json); 
                  root = json;
                  root.fixed = true;
                  root.x = w / 2;
                  root.y = h / 4;
                 
                 
                  // Build the path
                  var defs = vis.insert("svg:defs")
                      .data(["end"]);
                 
                 
                  defs.enter().append("svg:path")
                      .attr("d", "M0,-5L10,0L0,5");
                 
                     update();
                });
              }

              /**
               *   
               */
              function update() {
                var nodes = flatten(root),
                    links = d3.layout.tree().links(nodes);
               
                // Restart the force layout.
                force.nodes(nodes)
                      .links(links)
                      .gravity(0.05)
                  .charge(-1500)
                  .linkDistance(100)
                  .friction(0.5)
                  .linkStrength(function(l, i) {return 1; })
                  .size([w, h])
                  .on("tick", tick)
                      .start();
               
                 var path = vis.selectAll("path.link")
                    .data(links, function(d) { return d.target.id; });
               
                  path.enter().insert("svg:path")
                    .attr("class", "link")
                    // .attr("marker-end", "url(#end)")
                    .style("stroke", "#eee");
               
               
                // Exit any old paths.
                path.exit().remove();
               
               
               
                // Update the nodesâ€¦
                var node = vis.selectAll("g.node")
                    .data(nodes, function(d) { return d.id; });
               
               
                // Enter any new nodes.
                var nodeEnter = node.enter().append("svg:g")
                    .attr("class", "node")
                    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                    .on("click", click)
                    .call(force.drag);
               
                // Append a circle
                nodeEnter.append("svg:circle")
                    .attr("r", function(d) { return Math.sqrt(d.size) / 10 || 4.5; })
                    .style("fill", "#eee");
               
                 
                // Append images
                var images = nodeEnter.append("svg:image")
                      .attr("xlink:href",  function(d) { return d.img;})
                      .attr("x", function(d) { return -25;})
                      .attr("y", function(d) { return -25;})
                      .attr("height", 50)
                      .attr("width", 50);
                
                // make the image grow a little on mouse over and add the text details on click
                var setEvents = images
                        // Append hero text
                        .on( 'click', function (d) {
                          $.getJSON($SCRIPT_ROOT + '/query', {
                            x: $('#steamid').val()
                            }, function(data) {

                            if (data.result == 1) {
                              $("#tags").append("<button type=\"button\" class=\"btn btn-primary\">Primary</button>");
                              $('#valid').show();
                              $('#vis').empty();

                              draw_graph(); 
                            }
                          }); 
                         })

                        .on( 'mouseenter', function() {
                          // select element in current context
                          d3.select( this )
                            .transition()
                            .attr("x", function(d) { return -60;})
                            .attr("y", function(d) { return -60;})
                            .attr("height", 100)
                            .attr("width", 100);
                        })
                        // set back
                        .on( 'mouseleave', function() {
                          d3.select( this )
                            .transition()
                            .attr("x", function(d) { return -25;})
                            .attr("y", function(d) { return -25;})
                            .attr("height", 50)
                            .attr("width", 50);
                        });

                // Append hero name on roll over next to the node as well
                nodeEnter.append("text")
                    .attr("class", "nodetext")
                    .attr("x", x_browser)
                    .attr("y", y_browser +15)
                    .attr("fill", tcBlack)
                    .text(function(d) { return d.hero; });
               
               
                // Exit any old nodes.
                node.exit().remove();
               
               
                // Re-select for update.
                path = vis.selectAll("path.link");
                node = vis.selectAll("g.node");
               
              function tick() {
               
               
                  path.attr("d", function(d) {
               
                   var dx = d.target.x - d.source.x,
                         dy = d.target.y - d.source.y,
                         dr = Math.sqrt(dx * dx + dy * dy);
                         return   "M" + d.source.x + "," 
                          + d.source.y 
                          + "A" + dr + "," 
                          + dr + " 0 0,1 " 
                          + d.target.x + "," 
                          + d.target.y;
                });
                  node.attr("transform", nodeTransform);    
                }
              }

               
              /**
               * Gives the coordinates of the border for keeping the nodes inside a frame
               * http://bl.ocks.org/mbostock/1129492
               */ 
              function nodeTransform(d) {
                d.x =  Math.max(maxNodeSize, Math.min(w - (d.imgwidth/2 || 16), d.x));
                  d.y =  Math.max(maxNodeSize, Math.min(h - (d.imgheight/2 || 16), d.y));
                  return "translate(" + d.x + "," + d.y + ")";
                 }
               
              /**
               * Toggle children on click.
               */ 
              function click(d) {
                if (d.children) {
                  d._children = d.children;
                  d.children = null;
                } else {
                  d.children = d._children;
                  d._children = null;
                }
               
                update();
              }
               
               
              /**
               * Returns a list of all nodes under the root.
               */ 
              function flatten(root) {
                var nodes = []; 
                var i = 0;
               
                function recurse(node) {
                  if (node.children) 
                    node.children.forEach(recurse);
                  if (!node.id) 
                    node.id = ++i;
                  nodes.push(node);
                }
               
                recurse(root);
                return nodes;
              } 
                
                
              </script>
          </div>
        </div>
      </div>

      <div class="container" id="init">
      </div>
      <div class="container" id="invalid">
      </div>  
    </section>

    <!-- Footer -->
    <footer class="footer bg-light">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 h-100 text-center text-lg-left my-auto">
            <ul class="list-inline mb-2">
              <li class="list-inline-item">
                <a href="#">About</a>
              </li>
              <li class="list-inline-item">&sdot;</li>
              <li class="list-inline-item">
                <a href="#">Contact</a>
              </li>
              <li class="list-inline-item">&sdot;</li>
              <li class="list-inline-item">
                <a href="#">Terms of Use</a>
              </li>
              <li class="list-inline-item">&sdot;</li>
              <li class="list-inline-item">
                <a href="#">Privacy Policy</a>
              </li>
            </ul>
            <p class="text-muted small mb-4 mb-lg-0">&copy; Start Bootstrap 2017. All Rights Reserved.</p>
          </div>
          <div class="col-lg-6 h-100 text-center text-lg-right my-auto">
            <ul class="list-inline mb-0">
              <li class="list-inline-item mr-3">
                <a href="#">
                  <i class="fa fa-facebook fa-2x fa-fw"></i>
                </a>
              </li>
              <li class="list-inline-item mr-3">
                <a href="#">
                  <i class="fa fa-twitter fa-2x fa-fw"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="#">
                  <i class="fa fa-instagram fa-2x fa-fw"></i>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="static/vendor/jquery/jquery.min.js"></script>
    <script src="static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  </body>

</html>
